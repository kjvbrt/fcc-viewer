"use strict";(self.webpackChunkFCCViewer=self.webpackChunkFCCViewer||[]).push([[157],{9157:(x,I,f)=>{f.r(I),f.d(I,{TASImagePainter:()=>c});var m=f(8428),d=f(2374),p=f(4010),w=f(9228),D=f(3482);class c extends p.tK{decodeOptions(t){this.options={Zscale:!1},t&&t.indexOf("z")>=0&&(this.options.Zscale=!0)}createRGBA(t){let r=this.getObject();if(!r?.fPalette)return null;let a=new Array(4*(t+1)),e=1,i=r.fPalette;for(let l=0;l<=t;++l){let h=1*l/t;for(;i.fPoints[e]<h&&e<i.fPoints.length-1;)e++;let g=(i.fPoints[e]-h)/(i.fPoints[e]-i.fPoints[e-1]),s=(h-i.fPoints[e-1])/(i.fPoints[e]-i.fPoints[e-1]);a[4*l]=Math.min(255,Math.round((i.fColorRed[e-1]*g+i.fColorRed[e]*s)/256)),a[4*l+1]=Math.min(255,Math.round((i.fColorGreen[e-1]*g+i.fColorGreen[e]*s)/256)),a[4*l+2]=Math.min(255,Math.round((i.fColorBlue[e-1]*g+i.fColorBlue[e]*s)/256)),a[4*l+3]=Math.min(255,Math.round((i.fColorAlpha[e-1]*g+i.fColorAlpha[e]*s)/256))}return a}makeUrlFromImageBuf(t,r){this.rgba=this.createRGBA(1e3);let e=t.fImgBuf[0],i=t.fImgBuf[0];for(let o=1;o<t.fImgBuf.length;++o){let n=t.fImgBuf[o];e=Math.min(n,e),i=Math.max(n,i)}this.fContour={arr:new Array(200),rgba:this.rgba,getLevels(){return this.arr},getPaletteColor(o,n){if(!this.arr||!this.rgba)return"white";let u=4*Math.round((n-this.arr[0])/(this.arr[this.arr.length-1]-this.arr[0])*(this.rgba.length-4)/4);return"#"+(0,d.NC)(this.rgba[u],1)+(0,d.NC)(this.rgba[u+1],1)+(0,d.NC)(this.rgba[u+2],1)+(0,d.NC)(this.rgba[u+3],1)}};for(let o=0;o<200;o++)this.fContour.arr[o]=e+(i-e)/199*o;e>=i&&(i=e+1);let l=0,h=t.fWidth,g=0,s=t.fHeight;return r&&r.zoom_xmin!=r.zoom_xmax&&(l=Math.round(r.zoom_xmin*t.fWidth),h=Math.round(r.zoom_xmax*t.fWidth)),r&&r.zoom_ymin!=r.zoom_ymax&&(g=Math.round(r.zoom_ymin*t.fHeight),s=Math.round(r.zoom_ymax*t.fHeight)),((0,m.isNodeJs)()?f.e(560).then(f.t.bind(f,9560,19)).then(o=>o.default.createCanvas(h-l,s-g)):new Promise(o=>{let n=document.createElement("canvas");n.width=h-l,n.height=s-g,o(n)})).then(o=>{let n=o.getContext("2d"),u=n.getImageData(0,0,o.width,o.height),P=u.data;for(let b=g;b<s;++b){let C=(s-b-1)*(h-l)*4,M=b*t.fWidth;for(let B=l;B<h;++B){let _=4*Math.round((t.fImgBuf[M+B]-e)/(i-e)*1e3);P[C++]=this.rgba[_++],P[C++]=this.rgba[_++],P[C++]=this.rgba[_++],P[C++]=this.rgba[_++]}}return n.putImageData(u,0,0),{url:o.toDataURL(),constRatio:t.fConstRatio,is_buf:!0}})}makeUrlFromPngBuf(t){let r=t.fPngBuf,a="";if("string"==typeof r)a=r;else for(let e=0;e<r.length;++e)a+=String.fromCharCode(r[e]<0?256+r[e]:r[e]);return Promise.resolve({url:"data:image/png;base64,"+(0,m.btoa_func)(a),constRatio:!0})}drawImage(){let e,t=this.getObject(),r=this.getFramePainter(),a=r?r.getFrameRect():this.getPadPainter().getPadRect();return this.wheel_zoomy=!0,t._blob&&(15!=t._blob.length||t._blob[0]?3==t._blob.length&&t._blob[0]?(t.fPngBuf=t._blob[2],t.fPngBuf?.length!=t._blob[1]&&(console.error(`TASImage with png buffer _blob error ${t._blob[1]} != ${t.fPngBuf?.length}`),delete t.fPngBuf)):console.error(`TASImage _blob len ${t._blob.length} not recognized`):(t.fImageQuality=t._blob[1],t.fImageCompression=t._blob[2],t.fConstRatio=t._blob[3],t.fPalette={_typename:"TImagePalette",fUniqueID:t._blob[4],fBits:t._blob[5],fNumPoints:t._blob[6],fPoints:t._blob[7],fColorRed:t._blob[8],fColorGreen:t._blob[9],fColorBlue:t._blob[10],fColorAlpha:t._blob[11]},t.fWidth=t._blob[12],t.fHeight=t._blob[13],t.fImgBuf=t._blob[14],(t.fWidth*t.fHeight!=t.fImgBuf.length||t.fPalette.fNumPoints!=t.fPalette.fPoints.length)&&(console.error("TASImage _blob decoding error",t.fWidth*t.fHeight,"!=",t.fImgBuf.length,t.fPalette.fNumPoints,"!=",t.fPalette.fPoints.length),delete t.fImgBuf,delete t.fPalette)),delete t._blob),e=t.fImgBuf&&t.fPalette?this.makeUrlFromImageBuf(t,r):t.fPngBuf?this.makeUrlFromPngBuf(t):Promise.resolve({}),e.then(i=>(i.url&&this.createG(!!r).append("image").attr("href",i.url).attr("width",a.width).attr("height",a.height).attr("preserveAspectRatio",i.constRatio?null:"none"),i.url&&this.isMainPainter()&&i.is_buf&&r?this.drawColorPalette(this.options.Zscale,!0).then(()=>(r.setAxesRanges((0,m.create)("TAxis"),0,1,(0,m.create)("TAxis"),0,1,null,0,0),r.createXY({ndim:2,check_pad_range:!1}),r.addInteractivity())):this))}canZoomInside(t,r,a){let e=this.getObject();return!!e?.fImgBuf&&("x"==t&&(a-r)*e.fWidth>3||"y"==t&&(a-r)*e.fHeight>3)}drawColorPalette(t,r){if(!this.isMainPainter())return Promise.resolve(null);if(!this.draw_palette){let l=(0,m.create)("TPave");Object.assign(l,{_typename:"TPaletteAxis",fName:"TPave",fH:null,fAxis:(0,m.create)("TGaxis"),fX1NDC:.91,fX2NDC:.95,fY1NDC:.1,fY2NDC:.9,fInit:1}),l.fAxis.fChopt="+",this.draw_palette=l,this.fPalette=!0}let a=this.getPadPainter().findPainterFor(this.draw_palette);if(!t)return a&&(a.Enabled=!1,a.removeG()),Promise.resolve(null);let e=this.getFramePainter();if(r&&e){let l=this.draw_palette;l.fX2NDC=e.fX2NDC+.01+(l.fX2NDC-l.fX1NDC),l.fX1NDC=e.fX2NDC+.01,l.fY1NDC=e.fY1NDC,l.fY2NDC=e.fY2NDC}if(a)return a.Enabled=!0,a.drawPave("");let i=this.selectCurrentPad(this.getPadName());return w.TPavePainter.draw(this.getDom(),this.draw_palette).then(l=>{a=l,this.selectCurrentPad(i),a.$secondary=!0,a.redraw=function(){}})}toggleColz(){let t=this.getObject();t&&t.fPalette&&(this.options.Zscale=!this.options.Zscale,this.drawColorPalette(this.options.Zscale,!0))}redraw(t){let r=this.draw_g?this.draw_g.select("image"):null,a=this.getFramePainter();if(!r||r.empty()||"zoom"===t||!a)return this.drawImage();r.attr("width",a.getFrameWidth()).attr("height",a.getFrameHeight())}clickButton(t){return!!this.isMainPainter()&&"ToggleColorZ"===t&&(this.toggleColz(),!0)}fillToolbar(){let t=this.getPadPainter(),r=this.getObject();t&&r?.fPalette&&(t.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),t.showPadButtons())}static draw(t,r,a){let e=new c(t,r,a);return e.decodeOptions(a),(0,D.ensureTCanvas)(e,!1).then(()=>e.drawImage()).then(()=>(e.fillToolbar(),e))}}}}]);