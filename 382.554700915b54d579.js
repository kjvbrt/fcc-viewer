"use strict";(self.webpackChunkFCCViewer=self.webpackChunkFCCViewer||[]).push([[382],{5674:(S,P,h)=>{h.r(P),h.d(P,{THStackPainter:()=>g});var l=h(8428),k=h(2944),X=h(4010),C=h(9275),E=h(6982),M=h(3279),w=h(3482);class g extends X.tK{constructor(a,t,n){super(a,t,n),this.firstpainter=null,this.painters=[]}cleanup(){this.getPadPainter()?.cleanPrimitives(a=>a===this.firstpainter||this.painters.indexOf(a)>=0),delete this.firstpainter,delete this.painters,super.cleanup()}buildStack(a){if(!a.fHists)return!1;let t=a.fHists.arr.length;if(t<=0)return!1;let n=(0,l.create)("TList");n.Add((0,l.clone)(a.fHists.arr[0]),a.fHists.opt[0]);for(let e=1;e<t;++e){let i=(0,l.clone)(a.fHists.arr[e]),s=a.fHists.opt[e],r=n.arr[e-1];if(i.fNbins!=r.fNbins||i.fXaxis.fXmin!=r.fXaxis.fXmin||i.fXaxis.fXmax!=r.fXaxis.fXmax)return console.warn(`When drawing THStack, cannot sum-up histograms ${i.fName} and ${r.fName}`),n.Clear(),!1;for(let o=0;o<i.fArray.length;++o)i.fArray[o]+=r.fArray[o];n.Add(i,s)}return a.fStack=n,!0}getMinMax(a){let t={min:0,max:0},n=this.getObject(),e=this.getPadPainter().getRootPad(!0);const i=(s,r)=>{let o={min:0,max:0},f=!0,m=!0;if(-1111!==s.fMinimum&&(o.min=s.fMinimum,f=!1),-1111!==s.fMaximum&&(o.max=s.fMaximum,m=!1),!f&&!m)return o;let p=1,O=s.fXaxis.fNbins,T=1,_=1,H=!0;s.fXaxis.TestBit(M.VO.kAxisRange)&&(p=s.fXaxis.fFirst,O=s.fXaxis.fLast),0===s._typename.indexOf("TH2")&&(_=s.fYaxis.fNbins,s.fYaxis.TestBit(M.VO.kAxisRange)&&(T=s.fYaxis.fFirst,_=s.fYaxis.fLast));for(let c=T;c<=_;++c)for(let d=p;d<=O;++d){let x=s.getBinContent(d,c),u=r?s.getBinError(s.getBin(d,c)):0;f&&(H||x-u<o.min)&&(o.min=x-u),m&&(H||x+u>o.max)&&(o.max=x+u),H=!1}return o};if(this.options.nostack)for(let s=0;s<n.fHists.arr.length;++s){let r=i(n.fHists.arr[s],a);0==s?t=r:(t.min=Math.min(t.min,r.min),t.max=Math.max(t.max,r.max))}else t.min=i(n.fStack.arr[0],a).min,t.max=i(n.fStack.arr[n.fStack.arr.length-1],a).max;if(-1111!=n.fMaximum&&(t.max=n.fMaximum),t.max*=1+l.gStyle.fHistTopMargin,-1111!=n.fMinimum&&(t.min=n.fMinimum),e&&(1==this.options.ndim?e.fLogy:e.fLogz)){t.max<=0&&(t.max=1),t.min<=0&&(t.min=1e-4*t.max);let s=1/(1+.5*Math.log10(t.max/t.min)),r=1+.2*Math.log10(t.max/t.min);t.min*=s,t.max*=r}else t.min>0&&t.min<.05*t.max&&(t.min=0);return t}drawNextHisto(a,t){let n=this.getObject(),e=this.options.nostack?n.fHists:n.fStack,i=e&&e.arr?e.arr.length:0;if(a>=i)return Promise.resolve(this);let s=this.options.horder?a:i-a-1,r=e.arr[s],o=e.opt[s]||r.fOption||this.options.hopt;if(o.toUpperCase().indexOf(this.options.hopt)<0&&(o+=" "+this.options.hopt),this.options.draw_errors&&!o&&(o="E"),this.options._pfc||this.options._plc||this.options._pmc){let f=this.getMainPainter();if("function"==typeof f?.createAutoColor){let m=f.createAutoColor(i);this.options._pfc&&(r.fFillColor=m),this.options._plc&&(r.fLineColor=m),this.options._pmc&&(r.fMarkerColor=m)}}if(t){let f=t.getSubPadPainter(a+1);if(!f)return Promise.resolve(this);let m=f.selectCurrentPad(f.this_pad_name);return this.hdraw_func(f.getDom(),r,o).then(p=>(this.painters.push(p),f.selectCurrentPad(m),this.drawNextHisto(a+1,t)))}return s>0&&!this.options.nostack&&(r.$baseh=e.arr[s-1]),this.hdraw_func(this.getDom(),r,o+" same nostat").then(f=>(this.painters.push(f),this.drawNextHisto(a+1,t)))}decodeOptions(a){this.options||(this.options={}),Object.assign(this.options,{ndim:1,nostack:!1,same:!1,horder:!0,has_errors:!1,draw_errors:!1,hopt:""});let t=this.getObject(),n=t.fHistogram||(t.fHists?t.fHists.arr[0]:null)||(t.fStack?t.fStack.arr[0]:null);const e=r=>{if(r.fSumw2&&r.fSumw2.length>0)for(let o=0;o<r.fSumw2.length;++o)if(r.fSumw2[o]>0)return!0;return!1};if(n&&0==n._typename.indexOf("TH2")&&(this.options.ndim=2),2==this.options.ndim&&!a&&(a="lego1"),t.fHists&&!this.options.nostack)for(let r=0;r<t.fHists.arr.length;++r)this.options.has_errors=this.options.has_errors||e(t.fHists.arr[r]);this.options.nhist=t.fHists?t.fHists.arr.length:1;let i=new k.pc(a);this.options.nostack=i.check("NOSTACK"),i.check("STACK")&&(this.options.nostack=!1),this.options.same=i.check("SAME"),i.check("NOCLEAR"),this.options._pfc=i.check("PFC"),this.options._plc=i.check("PLC"),this.options._pmc=i.check("PMC"),this.options.pads=i.check("PADS"),this.options.pads&&(this.options.nostack=!0),this.options.hopt=i.remain();let s=i.check("LEGO");this.options.errors=i.check("E"),!this.options.nostack&&this.options.has_errors&&!s&&!i.check("HIST")&&this.options.hopt.indexOf("E")<0&&(this.options.draw_errors=!0),this.options.horder=this.options.nostack||s}createHistogram(a){let t=a.fHists,n=t?t.arr.length:0;if(!n){let s=(0,l.createHistogram)("TH1I",100);return s.fTitle=a.fTitle,s}let e=t.arr[0],i=(0,l.createHistogram)(1==this.options.ndim?"TH1I":"TH2I",e.fXaxis.fNbins,e.fYaxis.fNbins);i.fName="axis_hist",Object.assign(i.fXaxis,e.fXaxis),2==this.options.ndim&&Object.assign(i.fYaxis,e.fYaxis);for(let s=1;s<n;++s){let r=t.arr[s];i.fXaxis.fLabels||(i.fXaxis.fXmin=Math.min(i.fXaxis.fXmin,r.fXaxis.fXmin),i.fXaxis.fXmax=Math.max(i.fXaxis.fXmax,r.fXaxis.fXmax)),2==this.options.ndim&&!i.fYaxis.fLabels&&(i.fYaxis.fXmin=Math.min(i.fYaxis.fXmin,r.fYaxis.fXmin),i.fYaxis.fXmax=Math.max(i.fYaxis.fXmax,r.fYaxis.fXmax))}return i.fTitle=a.fTitle,i}updateObject(a){if(!this.matchObjectType(a))return!1;let t=this.getObject();if(t.fHists=a.fHists,t.fStack=a.fStack,t.fTitle=a.fTitle,this.options.nostack||(this.options.nostack=!this.buildStack(t)),this.firstpainter){let i=a.fHistogram;i||(i=t.fHistogram=this.createHistogram(t)),this.firstpainter.updateObject(i);let s=this.getMinMax(this.options.errors||this.options.draw_errors);this.firstpainter.options.minimum=s.min,this.firstpainter.options.maximum=s.max,1==this.options.ndim&&(this.firstpainter.ymin=s.min,this.firstpainter.ymax=s.max)}let n=this.options.nostack?t.fHists:t.fStack,e=n&&n.arr?n.arr.length:0;if(e!==this.painters.length)this.getPadPainter()?.cleanPrimitives(i=>this.painters.indexOf(i)>=0),this.painters=[],this.did_update=!0;else for(let i=0;i<e;++i)this.painters[i].updateObject(n.arr[this.options.horder?i:e-i-1]);return!0}redraw(){if(this.did_update)return delete this.did_update,this.drawNextHisto(0,this.options.pads?this.getPadPainter():null)}static draw(a,t,n){if(!t.fHists||!t.fHists.arr)return null;let e=new g(a,t,n),i=null,s=!1;return(0,w.ensureTCanvas)(e,!1).then(()=>{if(e.decodeOptions(n),e.hdraw_func=1==e.options.ndim?C.TH1Painter.draw:E.TH2Painter.draw,e.options.pads)return i=e.getPadPainter(),i.doingDraw()&&i.pad?.fPrimitives&&i.pad.fPrimitives.arr.length>1&&0==i.pad.fPrimitives.arr.indexOf(t)?(s=!0,void console.log("special case with THStack with is already rendered - do nothing")):(i.cleanPrimitives(f=>f!==e),i.divide(e.options.nhist));if(e.options.nostack||(e.options.nostack=!e.buildStack(t)),e.options.same)return;t.fHistogram||(t.fHistogram=e.createHistogram(t));let r=e.getMinMax(e.options.errors||e.options.draw_errors),o=e.options.hopt+" axis";return r&&(o+=";minimum:"+r.min+";maximum:"+r.max),e.hdraw_func(a,t.fHistogram,o).then(f=>{e.firstpainter=f})}).then(()=>s?e:e.drawNextHisto(0,i))}}}}]);