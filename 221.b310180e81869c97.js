"use strict";(self.webpackChunkFCCViewer=self.webpackChunkFCCViewer||[]).push([[221],{8221:(z,C,k)=>{k.r(C),k.d(C,{TGraphPainter:()=>T});var b=k(8428),P=k(8681),$=k(2944),S=k(4010),B=k(9833),A=k(9002),X=k(2063),Y=k(8200);const v=(0,b.BIT)(18);class T extends S.tK{constructor(t,i){super(t,i),this.axes_draw=!1,this.bins=null,this.xmin=this.ymin=this.xmax=this.ymax=0,this.wheel_zoomy=!0,this.is_bent="TGraphBentErrors"==i._typename,this.has_errors="TGraphErrors"==i._typename||"TGraphMultiErrors"==i._typename||"TGraphAsymmErrors"==i._typename||this.is_bent||i._typename.match(/^RooHist/)}redraw(){let t=Promise.resolve(!0);if(this.$redraw_hist){delete this.$redraw_hist;let i=this.getMainPainter();i?.$secondary&&this.axes_draw&&(t=i.redraw())}return t.then(()=>this.drawGraph())}cleanup(){delete this.interactive_bin,delete this.bins,super.cleanup()}get_gme(){let t=this.getObject();return"TGraphMultiErrors"==t?._typename?t:null}decodeOptions(t,i){"string"==typeof t&&0==t.indexOf("same ")&&(t=t.slice(5));let r=this.getObject(),s=!!this.get_gme(),n=[],l=i?!!this.getMainPainter():!this.axes_draw;this.options||(this.options={});const m=(x,e)=>{Object.assign(e,{Line:0,Curve:0,Rect:0,Mark:0,Bar:0,OutRange:0,EF:0,Fill:0,MainError:1,Ends:1,ScaleErrX:1}),s&&x.check("S=",!0)&&(e.ScaleErrX=x.partAsFloat()),x.check("L")&&(e.Line=1),x.check("F")&&(e.Fill=1),x.check("CC")&&(e.Curve=2),x.check("C")&&(e.Curve=1),x.check("*")&&(e.Mark=103),x.check("P0")&&(e.Mark=104),x.check("P")&&(e.Mark=1),x.check("B")&&(e.Bar=1,e.Errors=0),x.check("Z")&&(e.Errors=1,e.Ends=0),x.check("||")&&(e.Errors=1,e.MainError=0,e.Ends=1),x.check("[]")&&(e.Errors=1,e.MainError=0,e.Ends=2),x.check("|>")&&(e.Errors=1,e.Ends=3),x.check(">")&&(e.Errors=1,e.Ends=4),x.check("0")&&(e.Mark=1,e.Errors=1,e.OutRange=1),x.check("1")&&1==e.Bar&&(e.Bar=2),x.check("2")&&(e.Rect=1,e.Errors=0),x.check("3")&&(e.EF=1,e.Errors=0),x.check("4")&&(e.EF=2,e.Errors=0),x.check("5")&&(e.Rect=2,e.Errors=0),x.check("X")&&(e.Errors=0)};Object.assign(this.options,{Axis:"",NoOpt:0,PadStats:!1,original:t,second_x:!1,second_y:!1,individual_styles:!1}),s&&t&&(t.indexOf(";")>0?(n=t.split(";"),t=n.shift()):t.indexOf("_")>0&&(n=t.split("_"),t=n.shift()));let a=this.options,f=new $.pc(t);a.PadStats=f.check("USE_PAD_STATS");let y="";if(["USE_PAD_TITLE","LOGXY","LOGX","LOGY","LOGZ","GRIDXY","GRIDX","GRIDY","TICKXY","TICKX","TICKY"].forEach(x=>{f.check(x)&&(y+=";"+x)}),f.check("XAXIS_",!0)&&(y+=";XAXIS_"+f.part),f.check("YAXIS_",!0)&&(y+=";YAXIS_"+f.part),f.empty()&&(a.original=l?"lp":"alp",f=new $.pc(a.original)),f.check("NOOPT")&&(a.NoOpt=1),f.check("POS3D_",!0)&&(a.pos3d=f.partAsInt()-.5),a._pfc=f.check("PFC"),a._plc=f.check("PLC"),a._pmc=f.check("PMC"),f.check("A")&&(a.Axis=f.check("I")?"A":"AXIS"),f.check("X+")&&(a.Axis+="X+",a.second_x=l),f.check("Y+")&&(a.Axis+="Y+",a.second_y=l),f.check("RX")&&(a.Axis+="RX"),f.check("RY")&&(a.Axis+="RY"),s&&(a.blocks=[],a.skip_errors_x0=a.skip_errors_y0=!1,f.check("X0")&&(a.skip_errors_x0=!0),f.check("Y0")&&(a.skip_errors_y0=!0)),m(f,a),s&&f.check("S")&&(a.individual_styles=!0),void 0===a.Errors&&(a.Errors=!this.has_errors||s&&n.length?0:1),1==a.Mark&&1==r.fMarkerStyle&&(a.Mark=101),a.Line+a.Fill+a.Curve+a.Mark+a.Bar+a.EF+a.Rect+a.Errors==0&&f.empty()&&(a.Line=1),"TGraphErrors"==r._typename){let x=r.fEX.length,e=0;for(let h=0;h<x;++h)e=Math.max(e,r.fEX[h],r.fEY[h]);e<1e-100&&(a.Errors=0)}if(a.Axis)a.Axis.indexOf("A")<0&&(a.Axis="AXIS,"+a.Axis);else{let e=this.getPadPainter()?.getRootPad(!0);(!e||e?.fPrimitives?.arr[0]===r)&&(a.Axis="AXIS")}a.Axis+=y;for(let x=0;x<n.length;++x){let h={};m(new $.pc(n[x]),h),h.skip_errors_x0=a.skip_errors_x0,h.skip_errors_y0=a.skip_errors_y0,a.blocks.push(h)}}extractGmeErrors(t){if(!this.bins)return;let i=this.getObject();this.bins.forEach(r=>{r.eylow=i.fEyL[t][r.indx],r.eyhigh=i.fEyH[t][r.indx]})}createBins(){let t=this.getObject();if(!t)return;let i=0,r=t.fNpoints;"TCutG"===t._typename&&r>3&&r--,"TGraphErrors"==t._typename?i=1:"TGraphMultiErrors"==t._typename?i=2:("TGraphAsymmErrors"==t._typename||"TGraphBentErrors"==t._typename||t._typename.match(/^RooHist/))&&(i=3),this.bins=new Array(r);for(let s=0;s<r;++s){let n=this.bins[s]={x:t.fX[s],y:t.fY[s],indx:s};switch(i){case 1:n.exlow=n.exhigh=t.fEX[s],n.eylow=n.eyhigh=t.fEY[s];break;case 2:n.exlow=t.fExL[s],n.exhigh=t.fExH[s],n.eylow=t.fEyL[0][s],n.eyhigh=t.fEyH[0][s];break;case 3:n.exlow=t.fEXlow[s],n.exhigh=t.fEXhigh[s],n.eylow=t.fEYlow[s],n.eyhigh=t.fEYhigh[s]}0===s&&(this.xmin=this.xmax=n.x,this.ymin=this.ymax=n.y),i>0?(this.xmin=Math.min(this.xmin,n.x-n.exlow,n.x+n.exhigh),this.xmax=Math.max(this.xmax,n.x-n.exlow,n.x+n.exhigh),this.ymin=Math.min(this.ymin,n.y-n.eylow,n.y+n.eyhigh),this.ymax=Math.max(this.ymax,n.y-n.eylow,n.y+n.eyhigh)):(this.xmin=Math.min(this.xmin,n.x),this.xmax=Math.max(this.xmax,n.x),this.ymin=Math.min(this.ymin,n.y),this.ymax=Math.max(this.ymax,n.y))}}createHistogram(t,i,r){let s=this.xmin,n=this.xmax,l=this.ymin,m=this.ymax;s>=n&&(n=s+1),l>=m&&(m=l+1);let a=.1*(n-s),f=.1*(m-l),y=s-a,o=n+a,x=l-f,e=m+f;y<0&&s>=0&&(y=.9*s),o>0&&n<=0&&(o=0);let h=this.getObject();if(-1111!=h.fMinimum&&(x=l=h.fMinimum),-1111!=h.fMaximum&&(e=h.fMaximum),x<0&&l>=0&&(x=.9*l),!i&&!r&&(i=r=!0),!(t=h.fHistogram)){(t=h.fHistogram=(0,b.createHistogram)("TH1F",100)).fName=h.fName+"_h";let c=(0,b.BIT)(9);t.fBits=t.fBits|c,this._own_histogram=!0}return t.fTitle=h.fTitle,i&&(t.fXaxis.fXmin=y,t.fXaxis.fXmax=o),r&&(t.fYaxis.fXmin=x,t.fYaxis.fXmax=e,t.fMinimum=x,t.fMaximum=e),t}unzoomUserRange(t,i){let r=this.getObject();if(this._own_histogram||!r)return!1;let s=r.fHistogram;return i=i&&s&&(s.fYaxis.fXmin>this.ymin||s.fYaxis.fXmax<this.ymax),!(!(t=t&&s&&(s.fXaxis.fXmin>this.xmin||s.fXaxis.fXmax<this.xmax))&&!i||(this.createHistogram(null,t,i),this.getMainPainter()?.extractAxesProperties(1),0))}canOptimize(){return b.settings.OptimizeDraw>0&&!this.options.NoOpt}optimizeBins(t,i){if(this.bins.length<30&&!i)return this.bins;let r=null;if("function"==typeof i)for(let l=0;l<this.bins.length;++l)i(this.bins[l],l)?r||(r=0==l?[]:this.bins.slice(0,l)):r&&r.push(this.bins[l]);if(r||(r=this.bins),t||(t=5e5),r.length<t||!this.canOptimize())return r;let s=Math.floor(r.length/t);s<2&&(s=2);let n=[];for(let l=0;l<r.length;l+=s)n.push(r[l]);return n}getTooltips(t){let r=[],s=this.getFramePainter()?.getGrFuncs(this.options.second_x,this.options.second_y),n=this.get_gme();if(r.push(this.getObjectHint()),t&&s)if(void 0!==t.indx&&r.push("p = "+t.indx),r.push("x = "+s.axisAsText("x",t.x)),r.push("y = "+s.axisAsText("y",t.y)),n?r.push("error x = -"+s.axisAsText("x",n.fExL[t.indx])+"/+"+s.axisAsText("x",n.fExH[t.indx])):this.options.Errors&&"normal"==s.x_handle.kind&&(t.exlow||t.exhigh)&&r.push("error x = -"+s.axisAsText("x",t.exlow)+"/+"+s.axisAsText("x",t.exhigh)),n)for(let l=0;l<n.fNYErrors;++l)r.push(`error y${l} = -${s.axisAsText("y",n.fEyL[l][t.indx])}/+${s.axisAsText("y",n.fEyH[l][t.indx])}`);else(this.options.Errors||this.options.EF>0)&&"normal"==s.y_handle.kind&&(t.eylow||t.eyhigh)&&r.push("error y = -"+s.axisAsText("y",t.eylow)+"/+"+s.axisAsText("y",t.eyhigh));return r}get_main(){let t=this.getFramePainter();if(t&&t.grx&&t.gry)return t;let i=this.getPadPainter(),r=i?.getPadRect()||{width:800,height:600};return t={pad_layer:!0,pad:i?.getRootPad(!0),pw:r.width,ph:r.height,getFrameWidth(){return this.pw},getFrameHeight(){return this.ph},grx(s){return(s=this.pad.fLogx?s>0?Math.log10(s):this.pad.fUxmin:(s-this.pad.fX1)/(this.pad.fX2-this.pad.fX1))*this.pw},gry(s){return(1-(s=this.pad.fLogy?s>0?Math.log10(s):this.pad.fUymin:(s-this.pad.fY1)/(this.pad.fY2-this.pad.fY1)))*this.ph},getGrFuncs(){return this}},t.pad?t:null}appendExclusion(t,i,r,s){let n=[];for(let m=r.length-1;m>=0;--m){let a=r[m],f=Math.sqrt(a.dgrx**2+a.dgry**2);a.grx+=s*a.dgry/f,a.gry-=s*a.dgrx/f,n.push(a)}let l=(0,$.Cq)(t?"Lbezier":"Lline",n);this.draw_g.append("svg:path").attr("d",i.path+l.path+"Z").call(this.fillatt.func).style("opacity",.75)}drawBins(t,i,r,s,n,l,m,a){let f=this.getObject(),y=0,o=null;if(a&&l.excl_side&&(y=l.excl_width,l.width>0&&!i.Line&&!i.Curve&&(i.Line=1)),i.EF){o=this.optimizeBins(i.EF>1?2e4:0);for(let g=0;g<o.length;++g){let d=o[g];d.grx=t.grx(d.x),d.gry=t.gry(d.y-d.eylow)}let e=(0,$.Cq)(i.EF>1?"bezier":"line",o),h=[];for(let g=o.length-1;g>=0;--g){let d=o[g];d.gry=t.gry(d.y+d.eyhigh),h.push(d)}let c=(0,$.Cq)(i.EF>1?"Lbezier":"Lline",h);r.append("svg:path").attr("d",e.path+c.path+"Z").call(m.func),a&&(this.draw_kind="lines")}if(i.Line||i.Fill){let e="";"TCutG"==f._typename&&(i.Fill=1),i.Fill&&(e="Z",y=0),o||(o=this.optimizeBins(0));for(let d=0;d<o.length;++d){let _=o[d];_.grx=t.grx(_.x),_.gry=t.gry(_.y)}let h="line";y&&(h+="calc");let c=(0,$.Cq)(h,o);y&&this.appendExclusion(!1,c,o,y);let g=r.append("svg:path").attr("d",c.path+e);i.Line&&g.call(l.func),i.Fill?g.call(m.func):g.style("fill","none"),a&&(this.draw_kind="lines")}if(i.Curve){let e=o;if("lines"!=this.draw_kind||!e||1==i.Curve&&e.length>2e4){e=this.optimizeBins(1==i.Curve?2e4:0);for(let g=0;g<e.length;++g){let d=e[g];d.grx=t.grx(d.x),d.gry=t.gry(d.y)}}let h="bezier";y&&(h+="calc");let c=(0,$.Cq)(h,e);y&&this.appendExclusion(!0,c,e,y),r.append("svg:path").attr("d",c.path).call(l.func).style("fill","none"),a&&(this.draw_kind="lines")}let x=null;if((i.Errors||i.Rect||i.Bar)&&(o=this.optimizeBins(5e3,(e,h)=>{let c=t.grx(e.x);if(!i.Bar&&(c<0||c>s))return!0;let g=t.gry(e.y);return!i.Bar&&!i.OutRange&&(g<0||g>n)||(e.grx1=Math.round(c),e.gry1=Math.round(g),this.has_errors&&(e.grx0=Math.round(t.grx(e.x-i.ScaleErrX*e.exlow)-c),e.grx2=Math.round(t.grx(e.x+i.ScaleErrX*e.exhigh)-c),e.gry0=Math.round(t.gry(e.y-e.eylow)-g),e.gry2=Math.round(t.gry(e.y+e.eyhigh)-g),this.is_bent?(e.grdx0=Math.round(t.gry(e.y+f.fEXlowd[h])-g),e.grdx2=Math.round(t.gry(e.y+f.fEXhighd[h])-g),e.grdy0=Math.round(t.grx(e.x+f.fEYlowd[h])-c),e.grdy2=Math.round(t.grx(e.x+f.fEYhighd[h])-c)):e.grdx0=e.grdx2=e.grdy0=e.grdy2=0),!1)}),a&&(this.draw_kind="nodes"),x=r.selectAll(".grpoint").data(o).enter().append("svg:g").attr("class","grpoint").attr("transform",e=>`translate(${e.grx1},${e.gry1})`)),i.Bar){for(let c=1;c<o.length-1;++c)o[c].width=Math.max(2,(o[c+1].grx1-o[c-1].grx1)/2-2);switch(o.length){case 0:break;case 1:o[0].width=s/4;break;case 2:o[0].width=o[1].width=(o[1].grx1-o[0].grx1)/2;break;default:o[0].width=o[1].width,o[o.length-1].width=o[o.length-2].width}let e=Math.round(t.gry(0)),h=m;if(a){let c=this.getFramePainter(),g=c?.fillatt&&!c?.fillatt.empty()?c.fillatt.getFillColor():-1;g===m.getFillColor()&&(h=new X.Y({color:"white"==g?1:0,pattern:1001}))}x.append("svg:path").attr("d",c=>{c.bar=!0;let g=Math.round(-c.width/2),d=Math.round(c.width);return`M${g},${1!==i.Bar?0:c.gry1>e?e-c.gry1:0}h${d}v${1!==i.Bar?n>c.gry1?n-c.gry1:0:Math.abs(e-c.gry1)}h${-d}z`}).call(h.func)}if(i.Rect&&x.filter(e=>e.exlow>0&&e.exhigh>0&&e.eylow>0&&e.eyhigh>0).append("svg:path").attr("d",e=>(e.rect=!0,`M${e.grx0},${e.gry0}H${e.grx2}V${e.gry2}H${e.grx0}Z`)).call(m.func).call(2===i.Rect?l.func:()=>{}),this.error_size=0,i.Errors){let e=l.width+b.gStyle.fEndErrorSize,h=0,c=i.Ends?`m0,${e}v${-2*e}`:"",g=i.Ends?`m${e},0h${-2*e}`:"",d=c,_=c,p=g,M=g;const E=(u,F)=>{if(!i.MainError)return`M${u},${F}`;let O="M0,0";return u?O+(F?`L${u},${F}`:`H${u}`):F?`M0,0V${F}`:O};switch(i.Ends){case 2:h=Math.max(l.width+1,Math.round(.66*e)),d=`m${h},${e}h${-h}v${-2*e}h${h}`,_=`m${-h},${e}h${h}v${-2*e}h${-h}`,p=`m${-e},${h}v${-h}h${2*e}v${h}`,M=`m${-e},${-h}v${h}h${2*e}v${-h}`;break;case 3:e=Math.max(e,Math.round(8*f.fMarkerSize*.66)),h=Math.max(l.width+1,Math.round(.66*e)),d=`l${h},${e}v${-2*e}l${-h},${e}`,_=`l${-h},${e}v${-2*e}l${h},${e}`,p=`l${-e},${h}h${2*e}l${-e},${-h}`,M=`l${-e},${-h}h${2*e}l${-e},${h}`;break;case 4:e=Math.max(e,Math.round(8*f.fMarkerSize*.66)),h=Math.max(l.width+1,Math.round(.66*e)),d=`l${h},${e}m0,${-2*e}l${-h},${e}`,_=`l${-h},${e}m0,${-2*e}l${h},${e}`,p=`l${-e},${h}m${2*e},0l${-e},${-h}`,M=`l${-e},${-h}m${2*e},0l${-e},${h}`}this.error_size=e,e=Math.floor((l.width-1)/2);let w=x.filter(u=>u.exlow>0||u.exhigh>0||u.eylow>0||u.eyhigh>0);(i.skip_errors_x0||i.skip_errors_y0)&&(w=w.filter(u=>!(0==u.x&&i.skip_errors_x0||0==u.y&&i.skip_errors_y0))),!(0,b.isBatchMode)()&&b.settings.Tooltip&&a&&w.append("svg:path").style("fill","none").style("pointer-events","visibleFill").attr("d",u=>`M${u.grx0},${u.gry0}h${u.grx2-u.grx0}v${u.gry2-u.gry0}h${u.grx0-u.grx2}z`),w.append("svg:path").call(l.func).style("fill","none").attr("d",u=>(u.error=!0,(u.exlow>0?E(u.grx0+e,u.grdx0)+d:"")+(u.exhigh>0?E(u.grx2-e,u.grdx2)+_:"")+(u.eylow>0?E(u.grdy0,u.gry0-e)+M:"")+(u.eyhigh>0?E(u.grdy2,u.gry2+e)+p:"")))}if(i.Mark){this.createAttMarker({attr:f,style:i.Mark-100}),this.marker_size=this.markeratt.getFullSize(),this.markeratt.resetPos();let h,c,g,e="",d=!(0,b.isBatchMode)()&&b.settings.Tooltip&&(!this.markeratt.fill||this.marker_size<7)&&!x&&a,_="",p=Math.max(5,Math.round(.7*this.marker_size)),M=1e6/(this.markeratt.getMarkerLength()+7),E=1;o?this.canOptimize()&&o.length>1.5*M&&(E=Math.min(2,Math.round(o.length/M))):o=this.optimizeBins(M);for(let w=0;w<o.length;w+=E)h=o[w],c=t.grx(h.x),c>-this.marker_size&&c<s+this.marker_size&&(g=t.gry(h.y),g>-this.marker_size&&g<n+this.marker_size&&(e+=this.markeratt.create(c,g),d&&(_+=`M${c-p},${g-p}h${2*p}v${2*p}h${-2*p}z`)));e.length>0&&(r.append("svg:path").attr("d",e).call(this.markeratt.func),null===x&&"none"==this.draw_kind&&a&&(this.draw_kind=101==i.Mark?"path":"mark")),d&&_&&r.append("svg:path").attr("d",_).style("fill","none").style("pointer-events","visibleFill")}}appendQQ(t,i){let r=Math.max(t.scale_xmin,i.fXq1),s=Math.min(t.scale_xmax,i.fXq2),n=Math.max(t.scale_ymin,i.fYq1),l=Math.min(t.scale_ymax,i.fYq2),m="",a=(e,h,c,g)=>`M${t.grx(e)},${t.gry(h)}L${t.grx(c)},${t.gry(g)}`,f=(i.fYq2-i.fYq1)*(t.scale_xmin-i.fXq1)/(i.fXq2-i.fXq1)+i.fYq1,y=(i.fYq2-i.fYq1)*(t.scale_xmax-i.fXq1)/(i.fXq2-i.fXq1)+i.fYq1;m=f<t.scale_ymin?a((i.fXq2-i.fXq1)*(t.scale_ymin-i.fYq1)/(i.fYq2-i.fYq1)+i.fXq1,t.scale_ymin,r,n):a(t.scale_xmin,f,r,n),m+=y>t.scale_ymax?a(s,l,(i.fXq2-i.fXq1)*(t.scale_ymax-i.fYq1)/(i.fYq2-i.fYq1)+i.fXq1,t.scale_ymax):a(s,l,t.scale_xmax,y);let o=new A.rE({style:1,width:1,color:"black"}),x=new A.rE({style:2,width:1,color:"black"});this.draw_g.append("path").attr("d",a(r,n,s,l)).call(o.func).style("fill","none"),this.draw_g.append("path").attr("d",m).call(x.func).style("fill","none")}drawBins3D(){console.log("Load ./hist/TGraphPainter.mjs to draw graph in 3D")}drawGraph(){let t=this.get_main(),i=this.getObject();if(!t)return;if(this.options.pos3d)return this.drawBins3D(t,i);let r=!!this.get_gme(),s=t.getGrFuncs(this.options.second_x,this.options.second_y),n=t.getFrameWidth(),l=t.getFrameHeight();if(this.createG(!t.pad_layer),this.options._pfc||this.options._plc||this.options._pmc){let a=this.getMainPainter();if("function"==typeof a?.createAutoColor){let f=a.createAutoColor();this.options._pfc&&(i.fFillColor=f,delete this.fillatt),this.options._plc&&(i.fLineColor=f,delete this.lineatt),this.options._pmc&&(i.fMarkerColor=f,delete this.markeratt),this.options._pfc=this.options._plc=this.options._pmc=!1}}this.createAttLine({attr:i,can_excl:!0}),this.createAttFill({attr:i}),this.fillatt.used=!1,this.draw_kind="none",this.marker_size=0;let m=r?this.draw_g.append("svg:g"):this.draw_g;if(this.drawBins(s,this.options,m,n,l,this.lineatt,this.fillatt,!0),"TGraphQQ"==i._typename&&this.appendQQ(s,i),r){for(let a=0;a<i.fNYErrors;++a){let f=this.lineatt,y=this.fillatt;this.options.individual_styles&&(f=new A.rE({attr:i.fAttLine[a],std:!1}),y=new X.Y({attr:i.fAttFill[a],std:!1,svg:this.getCanvSvg()}));let o=this.draw_g.append("svg:g"),x=a<this.options.blocks.length?this.options.blocks[a]:this.options;this.extractGmeErrors(a),this.drawBins(s,x,o,n,l,f,y)}this.extractGmeErrors(0)}(0,b.isBatchMode)()||(0,Y.Z)(this,this.testEditable())}extractTooltip(t){if(!t)return null;if("lines"==this.draw_kind||"path"==this.draw_kind||"mark"==this.draw_kind)return this.extractTooltipForPath(t);if("nodes"!=this.draw_kind)return null;let i=this.getFramePainter(),r=i.getFrameHeight(),s=this.error_size,n=1===this.options.Bar,l=n?i.getGrFuncs(this.options.second_x,this.options.second_y):null,m=null,a=1e10,f=null,y=this.marker_size?Math.round(this.marker_size/2+1.5):0;if(this.draw_g.selectAll(".grpoint").each(function(){let h=(0,P.Ys)(this).datum();if(void 0===h)return;let g,c=(t.x-h.grx1)**2;if(1===t.nproc&&(c+=(t.y-h.gry1)**2),c>=a)return;if(h.error||h.rect||h.marker)g={x1:Math.min(-s,h.grx0,-y),x2:Math.max(s,h.grx2,y),y1:Math.min(-s,h.gry2,-y),y2:Math.max(s,h.gry0,y)};else if(h.bar){if(g={x1:-h.width/2,x2:h.width/2,y1:0,y2:r-h.gry1},n){let p=l.gry(0);g.y1=h.gry1>p?p-h.gry1:0,g.y2=h.gry1>p?0:p-h.gry1}}else g={x1:-5,x2:5,y1:-5,y2:5};let _=t.y>=h.gry1+g.y1&&t.y<=h.gry1+g.y2;t.x>=h.grx1+g.x1&&t.x<=h.grx1+g.x2&&(_||t.nproc>1)&&(a=c,m=this,f=g,f.exact=_)}),null===m)return null;let o=(0,P.Ys)(m).datum(),x=this.getObject(),e={name:x.fName,title:x.fTitle,x:o.grx1,y:o.gry1,color1:this.lineatt.color,lines:this.getTooltips(o),rect:f,d3bin:m};return e.user_info={obj:x,name:x.fName,bin:o.indx,cont:o.y,grx:o.grx1,gry:o.gry1},this.fillatt&&this.fillatt.used&&!this.fillatt.empty()&&(e.color2=this.fillatt.getFillColor()),f.exact&&(e.exact=!0),e.menu=e.exact,e.menu_dist=3,e.bin=o,e.binindx=o.indx,e}showTooltip(t){if(!t)return void(this.draw_g&&this.draw_g.select(".tooltip_bin").remove());if(t.usepath)return this.showTooltipForPath(t);let i=(0,P.Ys)(t.d3bin).datum(),r=this.draw_g.select(".tooltip_bin");r.empty()&&(r=this.draw_g.append("svg:rect").attr("class","tooltip_bin h1bin").style("pointer-events","none")),t.changed=r.property("current_bin")!==t.d3bin,t.changed&&r.attr("x",i.grx1+t.rect.x1).attr("width",t.rect.x2-t.rect.x1).attr("y",i.gry1+t.rect.y1).attr("height",t.rect.y2-t.rect.y1).style("opacity","0.3").property("current_bin",t.d3bin)}processTooltipEvent(t){let i=this.extractTooltip(t);return(!t||!t.disabled)&&this.showTooltip(i),i}findBestBin(t){if(!this.bins)return null;let a,f,y,o,x,i="lines"==this.draw_kind,r=-1,s=null,n=1e10,m=this.getFramePainter().getGrFuncs(this.options.second_x,this.options.second_y);for(o=0;o<this.bins.length;++o)x=this.bins[o],f=m.grx(x.x),y=m.gry(x.y),a=(t.x-f)**2+(t.y-y)**2,a<n&&(n=a,s=x,r=o);n>100&&i&&(s=null);let e=Math.max(this.lineatt.width+3,4);this.marker_size>0&&(e=Math.max(this.marker_size,e)),s&&(n=Math.sqrt((t.x-m.grx(s.x))**2+(t.y-m.gry(s.y))**2)),!i&&n>e&&(s=null),s||(r=-1);let h={bin:s,indx:r,dist:n,radius:Math.round(e)};if(!s&&i){n=1e10;const c=(M,E,w)=>E>=M&&M>=w||E<=M&&M<=w;let _,g=this.bins[0],d=m.grx(g.x),p=0;for(o=1;o<this.bins.length;++o)x=this.bins[o],f=m.grx(x.x),c(t.x,d,f)&&(_=m.gry(g.y),y=m.gry(x.y),Math.abs(f-d)<1?(p=t.y,a=c(t.y,_,y)?0:Math.min(Math.abs(t.y-_),Math.abs(t.y-y))):(p=_+(t.x-d)/(f-d)*(y-_),a=Math.abs(p-t.y)),a<n&&(n=a,h.linex=t.x,h.liney=p)),g=x,d=f;n<.5*e&&(h.linedist=n,h.closeline=!0)}return h}testEditable(t){let i=this.getObject();return!!i&&(("toggle"==t||void 0!==t&&!t!=i.TestBit(v))&&i.InvertBit(v),!i.TestBit(v))}extractTooltipForPath(t){if(null===this.bins)return null;let i=this.findBestBin(t);if(!i||!i.bin&&!i.closeline)return null;let r="lines"==this.draw_kind,s="mark"==this.draw_kind,l=this.getFramePainter().getGrFuncs(this.options.second_x,this.options.second_y),m=this.getObject(),a={name:m.fName,title:m.fTitle,x:i.bin?l.grx(i.bin.x):i.linex,y:i.bin?l.gry(i.bin.y):i.liney,color1:this.lineatt.color,lines:this.getTooltips(i.bin),usepath:!0};return a.user_info={obj:m,name:m.fName,bin:0,cont:0,grx:a.x,gry:a.y},a.ismark=s,a.islines=r,i.closeline?(a.menu=a.exact=!0,a.menu_dist=i.linedist):i.bin&&(this.options.EF&&r?(a.gry1=l.gry(i.bin.y-i.bin.eylow),a.gry2=l.gry(i.bin.y+i.bin.eyhigh)):a.gry1=a.gry2=l.gry(i.bin.y),a.binindx=i.indx,a.bin=i.bin,a.radius=i.radius,a.user_info.bin=i.indx,a.user_info.cont=i.bin.y,a.exact=Math.abs(t.x-a.x)<=i.radius&&(Math.abs(t.y-a.gry1)<=i.radius||Math.abs(t.y-a.gry2)<=i.radius),a.menu=a.exact,a.menu_dist=Math.sqrt((t.x-a.x)**2+Math.min(Math.abs(t.y-a.gry1),Math.abs(t.y-a.gry2))**2)),this.fillatt&&this.fillatt.used&&!this.fillatt.empty()&&(a.color2=this.fillatt.getFillColor()),r||(a.color1=this.getColor(m.fMarkerColor),a.color2||(a.color2=a.color1)),a}showTooltipForPath(t){let i=this.draw_g.select(".tooltip_bin");if(t&&t.bin){if(i.empty()&&(i=this.draw_g.append("svg:g").attr("class","tooltip_bin")),t.changed=i.property("current_bin")!==t.bin,t.changed)if(i.selectAll("*").remove(),i.property("current_bin",t.bin),t.ismark)i.append("svg:rect").attr("class","h1bin").style("pointer-events","none").style("opacity","0.3").attr("x",Math.round(t.x-t.radius)).attr("y",Math.round(t.y-t.radius)).attr("width",2*t.radius).attr("height",2*t.radius);else{i.append("svg:circle").attr("cy",Math.round(t.gry1)),Math.abs(t.gry1-t.gry2)>1&&i.append("svg:circle").attr("cy",Math.round(t.gry2));let r=i.selectAll("circle").attr("r",t.radius).attr("cx",Math.round(t.x));t.islines?(this.options.Line||this.options.Curve?r.call(this.lineatt.func):r.style("stroke","black"),this.options.Fill?r.call(this.fillatt.func):r.style("fill","none")):r.style("stroke","black"==t.color1?"green":"black").style("fill","none")}}else i.remove()}moveEnabled(){return this.testEditable()}moveStart(t,i){this.pos_dx=this.pos_dy=0;let r=this.extractTooltip({x:t,y:i});if(r&&r.exact&&void 0!==r.binindx){this.move_binindx=r.binindx,this.move_bin=r.bin;let n=this.getFramePainter()?.getGrFuncs(this.options.second_x,this.options.second_y);this.move_x0=n?n.grx(this.move_bin.x):t,this.move_y0=n?n.gry(this.move_bin.y):i}else delete this.move_binindx}moveDrag(t,i){if(this.pos_dx+=t,this.pos_dy+=i,void 0===this.move_binindx)this.draw_g.attr("transform",`translate(${this.pos_dx},${this.pos_dy})`);else{let s=this.getFramePainter()?.getGrFuncs(this.options.second_x,this.options.second_y);s&&this.move_bin&&(this.move_bin.x=s.revertAxis("x",this.move_x0+this.pos_dx),this.move_bin.y=s.revertAxis("y",this.move_y0+this.pos_dy),this.drawGraph())}}moveEnd(t){let i="";if(void 0===this.move_binindx){this.draw_g.attr("transform",null);let s=this.getFramePainter()?.getGrFuncs(this.options.second_x,this.options.second_y);if(s&&this.bins&&!t){for(let n=0;n<this.bins.length;++n){let l=this.bins[n];l.x=s.revertAxis("x",s.grx(l.x)+this.pos_dx),l.y=s.revertAxis("y",s.gry(l.y)+this.pos_dy),i+=`SetPoint(${l.indx},${l.x},${l.y});;`,0==l.indx&&this.matchObjectType("TCutG")&&(i+=`SetPoint(${this.getObject().fNpoints-1},${l.x},${l.y});;`)}this.drawGraph()}}else i=`SetPoint(${this.move_bin.indx},${this.move_bin.x},${this.move_bin.y});;`,0==this.move_bin.indx&&this.matchObjectType("TCutG")&&(i+=`SetPoint(${this.getObject().fNpoints-1},${this.move_bin.x},${this.move_bin.y});;`),delete this.move_binindx;i&&!t&&this.submitCanvExec(i)}fillContextMenu(t){return super.fillContextMenu(t),this.snapid||t.addchk(this.testEditable(),"Editable",()=>{this.testEditable("toggle"),this.drawGraph()}),t.size()>0}executeMenuCommand(t,i){if(super.executeMenuCommand(t,i))return!0;let r=this.getCanvPainter(),s=this.getFramePainter();if("RemovePoint"==t.fName||"InsertPoint"==t.fName){let n=s?.getLastEventPos();if(!r||r._readonly||!n)return!0;let l=this.extractTooltip(n);if("InsertPoint"==t.fName){let m=s?.getGrFuncs(this.options.second_x,this.options.second_y),a=m?.revertAxis("x",n.x)??0,f=m?.revertAxis("y",n.y)??0;this.submitCanvExec(`AddPoint(${a.toFixed(3)}, ${f.toFixed(3)})`,this.args_menu_id)}else this.args_menu_id&&void 0!==l?.binindx&&this.submitCanvExec(`RemovePoint(${l.binindx})`,this.args_menu_id);return!0}return!1}updateObject(t,i){if(!this.matchObjectType(t))return!1;i&&i!=this.options.original&&this.decodeOptions(i);let r=this.getObject();if(r.fBits=t.fBits,r.fTitle=t.fTitle,r.fX=t.fX,r.fY=t.fY,r.fNpoints=t.fNpoints,r.fMinimum=t.fMinimum,r.fMaximum=t.fMaximum,this.createBins(),delete this.$redraw_hist,this.axes_draw){let s=this.createHistogram(t.fHistogram);s.fTitle=r.fTitle;let n=this.getMainPainter();n?.$secondary&&(n.updateObject(s,this.options.Axis),this.$redraw_hist=!0)}return!0}canZoomInside(t,i,r){let s=this.getObject();if(!s||t!==(this.options.pos3d?"y":"x"))return!1;for(let n=0;n<s.fNpoints;++n)if(i<s.fX[n]&&s.fX[n]<r)return!0;return!1}clickButton(t){if("ToggleZoom"!==t)return!1;let i=this.getFramePainter();return!(!i||this.xmin===this.xmax&&this.ymin===this.ymax||(i.zoom(this.xmin,this.xmax,this.ymin,this.ymax),0))}findFunc(){let t=this.getObject();if(t?.fFunctions?.arr)for(let i=0;i<t.fFunctions.arr.length;++i){let r=t.fFunctions.arr[i];if("TF1"==r._typename||"TF2"==r._typename)return r}return null}findStat(){let t=this.getObject();if(t?.fFunctions?.arr)for(let i=0;i<t.fFunctions.arr.length;++i){let r=t.fFunctions.arr[i];if("TPaveStats"==r._typename&&"stats"==r.fName)return r}return null}createStat(){let t=this.findFunc();if(!t)return null;let i=this.findStat();if(i)return i;if(this.getCanvPainter()?.normal_canvas||this.options.PadStats)return null;this.create_stats=!0;const r=b.gStyle;return i=(0,b.create)("TPaveStats"),Object.assign(i,{fName:"stats",fOptStat:0,fOptFit:r.fOptFit||111,fBorderSize:1}),i.fX1NDC=r.fStatX-r.fStatW,i.fY1NDC=r.fStatY-r.fStatH,i.fX2NDC=r.fStatX,i.fY2NDC=r.fStatY,i.fFillColor=r.fStatColor,i.fFillStyle=r.fStatStyle,i.fTextAngle=0,i.fTextSize=r.fStatFontSize,i.fTextAlign=12,i.fTextColor=r.fStatTextColor,i.fTextFont=r.fStatFont,i.AddText(t.fName),this.getObject().fFunctions.Add(i),i}fillStatistic(t,i,r){let s=this.findFunc();return!!(s&&r&&this.create_stats)&&(t.clearPave(),t.fillFunctionStat(s,r),!0)}drawNextFunction(t){let i=this.getObject();if(t>=(i?.fFunctions?.arr?.length||0))return Promise.resolve(this);let r=this.getPadPainter(),s=i.fFunctions.arr[t],n=i.fFunctions.opt[t];return s.$main_painter=this,r.drawObject(this.getDom(),s,n).then(()=>this.drawNextFunction(t+1))}drawAxisHisto(){let t=this.createHistogram();return B.f.draw(this.getDom(),t,this.options.Axis)}static _drawGraph(t,i){t.decodeOptions(i,!0),t.createBins(),t.createStat(),!b.settings.DragGraphs&&!graph.TestBit(v)&&graph.InvertBit(v);let r=Promise.resolve();return(!t.getMainPainter()||t.options.second_x||t.options.second_y)&&t.options.Axis&&(r=t.drawAxisHisto().then(s=>{s&&(t.axes_draw=!0,t._own_histogram||(t.$primary=!0),s.$secondary=!0)})),r.then(()=>(t.addToPadPrimitives(),t.drawGraph())).then(()=>t.drawNextFunction(0))}static draw(t,i,r){return T._drawGraph(new T(t,i),r)}}}}]);